<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>A Guide to Crawl-ing with R</title>
  <meta name="description" content="This book provides mathematical and statistical background related to the modeling of animal movement from satellite telemetry data as well as pragmatic approaches and examples for implementing analysis with the R package, crawl.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="A Guide to Crawl-ing with R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://jmlondon.github.io/crawl-workshop/" />
  
  <meta property="og:description" content="This book provides mathematical and statistical background related to the modeling of animal movement from satellite telemetry data as well as pragmatic approaches and examples for implementing analysis with the R package, crawl." />
  <meta name="github-repo" content="jmlondon/crawl-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="A Guide to Crawl-ing with R" />
  
  <meta name="twitter:description" content="This book provides mathematical and statistical background related to the modeling of animal movement from satellite telemetry data as well as pragmatic approaches and examples for implementing analysis with the R package, crawl." />
  

<meta name="author" content="Josh M. London and Devin S. Johnson">


<meta name="date" content="2018-10-29">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="crawl-theory.html">

<script src="assets/jquery-2.2.3/jquery.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About the Authors</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Theoretical Crawling</b></span></li>
<li class="chapter" data-level="1" data-path="crawl-theory.html"><a href="crawl-theory.html"><i class="fa fa-check"></i><b>1</b> The Mathematics and Statistics of Animal Movement</a><ul>
<li class="chapter" data-level="1.1" data-path="crawl-theory.html"><a href="crawl-theory.html#mathematics"><i class="fa fa-check"></i><b>1.1</b> Mathematics</a><ul>
<li class="chapter" data-level="1.1.1" data-path="crawl-theory.html"><a href="crawl-theory.html#discrete-time-random-walks"><i class="fa fa-check"></i><b>1.1.1</b> Discrete-time random walks</a></li>
<li class="chapter" data-level="1.1.2" data-path="crawl-theory.html"><a href="crawl-theory.html#correlated-random-walks"><i class="fa fa-check"></i><b>1.1.2</b> Correlated random walks</a></li>
<li class="chapter" data-level="1.1.3" data-path="crawl-theory.html"><a href="crawl-theory.html#brownian-motion"><i class="fa fa-check"></i><b>1.1.3</b> Brownian motion</a></li>
<li class="chapter" data-level="1.1.4" data-path="crawl-theory.html"><a href="crawl-theory.html#ornstein-ulenbeck-ou-process"><i class="fa fa-check"></i><b>1.1.4</b> Ornstein-Ulenbeck (OU) process</a></li>
<li class="chapter" data-level="1.1.5" data-path="crawl-theory.html"><a href="crawl-theory.html#stochastic-differential-equations"><i class="fa fa-check"></i><b>1.1.5</b> Stochastic differential equations</a></li>
<li class="chapter" data-level="1.1.6" data-path="crawl-theory.html"><a href="crawl-theory.html#integrated-sdes"><i class="fa fa-check"></i><b>1.1.6</b> Integrated SDEs</a></li>
<li class="chapter" data-level="1.1.7" data-path="crawl-theory.html"><a href="crawl-theory.html#continuous-time-crw"><i class="fa fa-check"></i><b>1.1.7</b> Continuous-time CRW</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="crawl-theory.html"><a href="crawl-theory.html#statistics"><i class="fa fa-check"></i><b>1.2</b> Statistics</a><ul>
<li class="chapter" data-level="1.2.1" data-path="crawl-theory.html"><a href="crawl-theory.html#maximum-likelihood-inference"><i class="fa fa-check"></i><b>1.2.1</b> Maximum likelihood inference</a></li>
<li class="chapter" data-level="1.2.2" data-path="crawl-theory.html"><a href="crawl-theory.html#bayesian-inference"><i class="fa fa-check"></i><b>1.2.2</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.2.3" data-path="crawl-theory.html"><a href="crawl-theory.html#state-space-models"><i class="fa fa-check"></i><b>1.2.3</b> State-space models</a></li>
<li class="chapter" data-level="1.2.4" data-path="crawl-theory.html"><a href="crawl-theory.html#kalman-filtersmoother-kfs"><i class="fa fa-check"></i><b>1.2.4</b> Kalman filter/smoother (KFS)</a></li>
<li class="chapter" data-level="1.2.5" data-path="crawl-theory.html"><a href="crawl-theory.html#practical-bayesian-inference"><i class="fa fa-check"></i><b>1.2.5</b> Practical Bayesian inference</a></li>
<li class="chapter" data-level="1.2.6" data-path="crawl-theory.html"><a href="crawl-theory.html#process-imputation"><i class="fa fa-check"></i><b>1.2.6</b> Process imputation</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Practical Crawling</b></span></li>
<li class="chapter" data-level="2" data-path="crawl-practical.html"><a href="crawl-practical.html"><i class="fa fa-check"></i><b>2</b> A Pragmatic Guide for Analysis with <code>crawl</code></a><ul>
<li class="chapter" data-level="2.1" data-path="crawl-practical.html"><a href="crawl-practical.html#analysis-and-coding-principles"><i class="fa fa-check"></i><b>2.1</b> Analysis and Coding Principles</a><ul>
<li class="chapter" data-level="2.1.1" data-path="crawl-practical.html"><a href="crawl-practical.html#source-data-are-read-only"><i class="fa fa-check"></i><b>2.1.1</b> Source Data are Read Only</a></li>
<li class="chapter" data-level="2.1.2" data-path="crawl-practical.html"><a href="crawl-practical.html#script-everything"><i class="fa fa-check"></i><b>2.1.2</b> Script Everything</a></li>
<li class="chapter" data-level="2.1.3" data-path="crawl-practical.html"><a href="crawl-practical.html#document-along-the-way"><i class="fa fa-check"></i><b>2.1.3</b> Document Along the Way</a></li>
<li class="chapter" data-level="2.1.4" data-path="crawl-practical.html"><a href="crawl-practical.html#embrace-the-tidyverse"><i class="fa fa-check"></i><b>2.1.4</b> Embrace the Tidyverse</a></li>
<li class="chapter" data-level="2.1.5" data-path="crawl-practical.html"><a href="crawl-practical.html#anticipate-errors-trap-them"><i class="fa fa-check"></i><b>2.1.5</b> Anticipate Errors &amp; Trap Them</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="crawl-practical.html"><a href="crawl-practical.html#assembling-source-data"><i class="fa fa-check"></i><b>2.2</b> Assembling Source Data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="crawl-practical.html"><a href="crawl-practical.html#read-in-csv-source-data"><i class="fa fa-check"></i><b>2.2.1</b> Read In CSV Source Data</a></li>
<li class="chapter" data-level="2.2.2" data-path="crawl-practical.html"><a href="crawl-practical.html#specify-column-data-types"><i class="fa fa-check"></i><b>2.2.2</b> Specify Column Data Types</a></li>
<li class="chapter" data-level="2.2.3" data-path="crawl-practical.html"><a href="crawl-practical.html#import-from-many-files"><i class="fa fa-check"></i><b>2.2.3</b> Import From Many Files</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="crawl-practical.html"><a href="crawl-practical.html#tidy-data-for-telemetry"><i class="fa fa-check"></i><b>2.3</b> Tidy Data for Telemetry</a><ul>
<li class="chapter" data-level="2.3.1" data-path="crawl-practical.html"><a href="crawl-practical.html#standard-column-names"><i class="fa fa-check"></i><b>2.3.1</b> Standard Column Names</a></li>
<li class="chapter" data-level="2.3.2" data-path="crawl-practical.html"><a href="crawl-practical.html#tidy-a-messy-histos-file"><i class="fa fa-check"></i><b>2.3.2</b> Tidy a Messy ‘Histos’ File</a></li>
<li class="chapter" data-level="2.3.3" data-path="crawl-practical.html"><a href="crawl-practical.html#gathering-data-with-tidyr"><i class="fa fa-check"></i><b>2.3.3</b> Gathering Data with <code>tidyr</code></a></li>
<li class="chapter" data-level="2.3.4" data-path="crawl-practical.html"><a href="crawl-practical.html#visualizing-source-data"><i class="fa fa-check"></i><b>2.3.4</b> Visualizing Source Data</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="crawl-practical.html"><a href="crawl-practical.html#preparing-input-data-for-crawl"><i class="fa fa-check"></i><b>2.4</b> Preparing Input Data for <code>crawl</code></a><ul>
<li class="chapter" data-level="2.4.1" data-path="crawl-practical.html"><a href="crawl-practical.html#error-parameters-for-gps-data"><i class="fa fa-check"></i><b>2.4.1</b> Error Parameters for GPS Data</a></li>
<li class="chapter" data-level="2.4.2" data-path="crawl-practical.html"><a href="crawl-practical.html#known-locations"><i class="fa fa-check"></i><b>2.4.2</b> Known Locations</a></li>
<li class="chapter" data-level="2.4.3" data-path="crawl-practical.html"><a href="crawl-practical.html#duplicate-times"><i class="fa fa-check"></i><b>2.4.3</b> Duplicate Times</a></li>
<li class="chapter" data-level="2.4.4" data-path="crawl-practical.html"><a href="crawl-practical.html#course-speed-filter"><i class="fa fa-check"></i><b>2.4.4</b> Course Speed Filter</a></li>
<li class="chapter" data-level="2.4.5" data-path="crawl-practical.html"><a href="crawl-practical.html#create-a-spatial-object"><i class="fa fa-check"></i><b>2.4.5</b> Create a Spatial Object</a></li>
<li class="chapter" data-level="2.4.6" data-path="crawl-practical.html"><a href="crawl-practical.html#merging-with-activity-data"><i class="fa fa-check"></i><b>2.4.6</b> Merging with Activity Data</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="crawl-practical.html"><a href="crawl-practical.html#determining-your-model-parameters"><i class="fa fa-check"></i><b>2.5</b> Determining Your Model Parameters</a><ul>
<li class="chapter" data-level="2.5.1" data-path="crawl-practical.html"><a href="crawl-practical.html#install-latest-version-of-crawl"><i class="fa fa-check"></i><b>2.5.1</b> Install Latest Version of <code>crawl</code></a></li>
<li class="chapter" data-level="2.5.2" data-path="crawl-practical.html"><a href="crawl-practical.html#create-a-nested-data-structure"><i class="fa fa-check"></i><b>2.5.2</b> Create a Nested Data Structure</a></li>
<li class="chapter" data-level="2.5.3" data-path="crawl-practical.html"><a href="crawl-practical.html#create-ellipse-error-columns"><i class="fa fa-check"></i><b>2.5.3</b> Create Ellipse Error Columns</a></li>
<li class="chapter" data-level="2.5.4" data-path="crawl-practical.html"><a href="crawl-practical.html#create-model-parameters"><i class="fa fa-check"></i><b>2.5.4</b> Create Model Parameters</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="crawl-practical.html"><a href="crawl-practical.html#fitting-with-crawlcrwmle"><i class="fa fa-check"></i><b>2.6</b> Fitting with <code>crawl::crwMLE()</code></a></li>
<li class="chapter" data-level="2.7" data-path="crawl-practical.html"><a href="crawl-practical.html#exploring-and-troubleshooting-model-results"><i class="fa fa-check"></i><b>2.7</b> Exploring and Troubleshooting Model Results</a></li>
<li class="chapter" data-level="2.8" data-path="crawl-practical.html"><a href="crawl-practical.html#predicting-a-movement-track"><i class="fa fa-check"></i><b>2.8</b> Predicting a Movement Track</a></li>
<li class="chapter" data-level="2.9" data-path="crawl-practical.html"><a href="crawl-practical.html#simulating-tracks-from-the-posterior"><i class="fa fa-check"></i><b>2.9</b> Simulating Tracks from the Posterior</a></li>
<li class="chapter" data-level="2.10" data-path="crawl-practical.html"><a href="crawl-practical.html#visualization-of-results"><i class="fa fa-check"></i><b>2.10</b> Visualization of Results</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A Guide to Crawl-ing with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="a-pragmatic-guide-for-analysis-with-crawl" class="section level1">
<h1><span class="header-section-number">2</span> A Pragmatic Guide for Analysis with <code>crawl</code></h1>
<p>The <code>crawl</code> package is designed and built with the idea that it should be
accessible and useful to a research biologist with some intermediate R
skills and an understanding of the basic statistical theory behind
the analysis of animal movement. This portion of the book will focus on
providing the user with suggested principles, workflows, and pragmatic
approaches that, if followed, should make analysis with <code>crawl</code> more
efficient and reliable.</p>
<blockquote>
<p>Telemetry data are collected on a wide range of species and come in a number
of formats and data structures. The code and examples provided here were
developed from data the authors are most familiar with. You will very
likely <strong>NOT</strong> be able to just copy and paste the code and apply to your data.
We suggest you focus more on understanding what the code is doing and then
write your own version of the code to meet your data and your research needs.</p>
</blockquote>
<p>This content is broken up in the following sections:</p>
<ol style="list-style-type: decimal">
<li>Analysis and Coding Principles</li>
<li>Assembling Source Data</li>
<li>Tidy Data for Telemetry</li>
<li>Preparing Input Data for <code>crawl</code></li>
<li>Determining Your Model Parameters</li>
<li>Exploring and Troubleshooting Model Results</li>
<li>Predicting a Movement Track</li>
<li>Simulating Tracks from the Posterior</li>
<li>Visualization of Results</li>
</ol>
<div id="analysis-and-coding-principles" class="section level2">
<h2><span class="header-section-number">2.1</span> Analysis and Coding Principles</h2>
<p>As with anything in science and R, there are a number of right ways to
approach a problem. The workflows and principles outlined here aren’t the only
way to use <code>crawl</code>. However, this content has been developed after years of
working with researchers and troubleshooting common issues. For most users,
following this guide will prove a successful endeavor. More advanced users
or those with specific needs should feel free to refer to this as a starting
point but then expand to meet their need.</p>
<div id="source-data-are-read-only" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Source Data are Read Only</h3>
<p>Source data should not be edited. In many cases, the financial and personal
investment required to obtain these data is significant. In addition, the
unique timing, location, and nature of the data cannot be replicated so every
effort should be employed to preserve the integrity of source data as they
were collected. All efforts should be made to also insure that source data
are stored in plain text or well described open formats. This approach provides
researchers confidence that data will be available and usable well into the
future.</p>
</div>
<div id="script-everything" class="section level3">
<h3><span class="header-section-number">2.1.2</span> Script Everything</h3>
<p>In all likelihood, the format of any source data will not be condusive to
established analytical procedures. For example, <code>crawl</code> cannot accept a raw
data file downloaded from ArgosWeb or the Wildlife Computers Data Portal. Some
amount of data carpentry is required. Keeping with the principles of
reproducibility, all data assembly and carpentry should be scripted. Here, we
rely on the R programming language for our scripts, but Python or other
similar languages will also meet this need.</p>
</div>
<div id="document-along-the-way" class="section level3">
<h3><span class="header-section-number">2.1.3</span> Document Along the Way</h3>
<p>Scripting the data assembly should be combined with an effort to properly
document the process. Documentation is an important component of reproducibility
and, if done as part of the scritping and development process, provides an
easier workflow for publishing results and data to journals and repositories.
The <code>rmarkdown</code>, <code>bookdown</code>, and <code>knitr</code> packages provide an excellent
framework for combining your R scripts with documentation. This entire
book is written with <code>bookdown</code> and <code>knitr</code>.</p>
</div>
<div id="embrace-the-tidyverse" class="section level3">
<h3><span class="header-section-number">2.1.4</span> Embrace the Tidyverse</h3>
<p>The <em>tidyverse</em> describes a set of R packages developed by, or in association
with, Hadley Wickham. Tidy data principles are outlined in a 2014
<a href="http://dx.doi.org/10.18637/jss.v059.i10">paper</a> published in the
<em>Journal of Statistical Software</em>. The key tennants of tidy data are:</p>
<ol style="list-style-type: decimal">
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observational unit forms a table.</li>
</ol>
<p>Location data from telemetry deployments often follows this type of structure:
each location estimate is a row and the columns all represent variable
attributes associated with that location. Additionally, the location data
are usually organized into a single table. Behavior data, however, often
comes in a less structured format. Different behavior type data are sometimes
mixed within a single table and column headings do not consistently describe
the same variable (e.g. <em>Bin1</em>, <em>Bin2</em>, etc). There are valid reasons for
tag vendors and data providers to transmit the source data in this way, but the
structure is not condusive to analysis.</p>
<p>The <code>tidyverse</code> package is a wrapper for a number of separate packages that each
contribute to the tidy’ing of data. The <code>tidyr</code>, <code>dplyr</code>, <code>readr</code>, and <code>purrr</code>
packages are key components. In addition, the <code>lubridate</code> package (not included
in the <code>tidyverse</code> package) is especially useful for consistent maninpulation
of date-time values. More information and documentation for the packages can be
found at the <a href="http://tidyverse.org">tidyverse.org</a> website.</p>
</div>
<div id="anticipate-errors-trap-them" class="section level3">
<h3><span class="header-section-number">2.1.5</span> Anticipate Errors &amp; Trap Them</h3>
<p>Use R’s error trapping functions (<code>try()</code> and <code>tryCatch()</code>) in areas of your
code where you anticipate parsing errors or potential issues with convergence
or fit. The <code>purrr::safely()</code> function also provides a great service.</p>
</div>
</div>
<div id="assembling-source-data" class="section level2">
<h2><span class="header-section-number">2.2</span> Assembling Source Data</h2>
<p>Where and how you access the source data for your telemetry study will depend
on the type of tag and vendor. Argos location data is available to users from the
Argos website and many third party sites and respositories (e.g. movebank,
sea-turtle.org) have API connections to ArgosWeb that can faciliate data access.
Each tag manufacturer often has additional data streams included within the
Argos transmission that require specific software or processing to translate.
Both the Sea Mammal Research Unit (SMRU) and Wildlife Computers provide online
data portals that provide users access to the location and additional sensor
data.</p>
<p>Regardless of how the data are retrieved, these files should be treated as read
only and not edited. ArgosWeb and vendors have, typically, kept the data formats
and structure consistent over time. This affords end users the ability to develop
custom processing scripts without much fear the formats will change and break
their scripts.</p>
<div id="read-in-csv-source-data" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Read In CSV Source Data</h3>
<p>Here we will demonstrate the development of such a script using data downloaded
from the Wildlife Computers (Redmond, Washington, USA) data portal. All data are
grouped by deployment and presented in various comma-separated files. The
<code>*-Locations.csv</code> contains all of the Argos location estimates determined for
the deployment. At a minimum, this file includes identifying columns such as
<code>DeployID</code>, <code>PTT</code>, <code>Date</code>, <code>Quality</code>, <code>Type</code>, <code>Latitude</code>, and <code>Longitude</code>. If
the Argos Kalman filtering approach has been enabled (which it should be for any
modern tag deployment), then additional data will be found in columns that
describe the error ellipses (e.g. <code>Error Semi-major axis</code>, <code>Error Semi-minor axis</code>, <code>Error Ellipse orientation</code>). Note, if the tag transmitted GPS/FastLoc
data, this file will list those records as <code>Type = 'FastGPS'</code>.</p>
<p>The other file of interest we will be working with is an example <code>*-Histos.csv</code>.
These files include dive and haul-out behavior data derived from sensors on the
tag. Most notably, the pressure transducer (for depth) and the salt-water switch
(for determining wet/dry status). We will focus on processing this file to
demonstrate how we can properly <em>tidy</em> our data.</p>
<p>We will rely on the <code>tidyverse</code> set of packages plus <code>purrr</code> and <code>lubridate</code>
to make reading and processing these files easier and more reliable. Since we are
working with spatial data, the <code>sf</code> package will be used (as well as a few
legacy functions from the <code>sp</code> package).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="cf">if</span>(<span class="op">!</span><span class="kw">require</span>(devtools)) <span class="kw">install.packages</span>(<span class="st">&#39;devtools&#39;</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">library</span>(sp)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">library</span>(sf)</a></code></pre></div>
<p>The <code>readr</code> includes the <code>read_csv()</code> function which we will rely on to read
the csv data into R.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">path_to_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">&quot;examples&quot;</span>,<span class="st">&quot;data&quot;</span>,<span class="st">&quot;160941-Locations.csv&quot;</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">tbl_locs &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">read_csv</span>(path_to_file)</a></code></pre></div>
</div>
<div id="specify-column-data-types" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Specify Column Data Types</h3>
<p>The <code>readr::read_csv()</code> function tries to interpret the proper data types for
each of the columns and provides us the column specifications it determined. In
most cases, the function gets this correct. However, if we examine the <code>cols()</code>
specification selected, we see that the <code>Date</code> column was
read in as a <em>character</em> data type.</p>
<p>To correct this, we need to provide our own <code>cols()</code> specification. We can do
this by simply modifying the specification <code>readr::read_csv()</code> provided us. In
this case, we want the <code>Date</code> column to rely on <code>col_datetime</code> and to parse
the character string using the format <code>%H:%M:%S %d-%b-%Y</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">my_cols &lt;-<span class="st"> </span><span class="kw">cols</span>(</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  <span class="dt">DeployID =</span> <span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  <span class="dt">Ptt =</span> <span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="dt">Instr =</span> <span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="dt">Date =</span> <span class="kw">col_datetime</span>(<span class="st">&quot;%H:%M:%S %d-%b-%Y&quot;</span>),</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">  <span class="dt">Type =</span> <span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">  <span class="dt">Quality =</span> <span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">  <span class="dt">Latitude =</span> <span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">  <span class="dt">Longitude =</span> <span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">  <span class="st">`</span><span class="dt">Error radius</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">  <span class="st">`</span><span class="dt">Error Semi-major axis</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  <span class="st">`</span><span class="dt">Error Semi-minor axis</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">  <span class="st">`</span><span class="dt">Error Ellipse orientation</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">  <span class="dt">Offset =</span> <span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">  <span class="st">`</span><span class="dt">Offset orientation</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  <span class="st">`</span><span class="dt">GPE MSD</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  <span class="st">`</span><span class="dt">GPE U</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  <span class="dt">Count =</span> <span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">  <span class="dt">Comment =</span> <span class="kw">col_character</span>()</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">)</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">tbl_locs &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">read_csv</span>(path_to_file,<span class="dt">col_types =</span> my_cols)</a></code></pre></div>
</div>
<div id="import-from-many-files" class="section level3">
<h3><span class="header-section-number">2.2.3</span> Import From Many Files</h3>
<p>In most instances you’ll likely want to read in data from multiple deployments.
The <code>purrr::map()</code> function can be combined with <code>readr::read_csv()</code> and
<code>dplyr::bind_rows()</code> make this easy.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">tbl_locs &lt;-<span class="st"> </span><span class="kw">dir</span>(<span class="st">&#39;examples/data/&#39;</span>, <span class="st">&quot;*-Locations.csv&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="st">  </span>purrr<span class="op">::</span><span class="kw">map</span>(read_csv,<span class="dt">col_types =</span> my_cols) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">bind_rows</span>()</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">tbl_locs <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(DeployID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(<span class="dt">num_locs =</span> <span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">            <span class="dt">start_date =</span> <span class="kw">min</span>(Date),</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">            <span class="dt">end_date =</span> <span class="kw">max</span>(Date))</a></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   DeployID            num_locs start_date          end_date           
##   &lt;chr&gt;                  &lt;int&gt; &lt;dttm&gt;              &lt;dttm&gt;             
## 1 PV2016_3019_16A0222     3064 2016-09-21 02:54:02 2017-02-15 08:15:22
## 2 PV2016_3024_15A0909      976 2016-09-22 02:48:00 2017-02-15 05:06:20</code></pre>
</div>
</div>
<div id="tidy-data-for-telemetry" class="section level2">
<h2><span class="header-section-number">2.3</span> Tidy Data for Telemetry</h2>
<p>A key tennat of tidy data is that each row represents a single observation. For
location data, regardless of the data source, this is typical of the source data
structure. Each line in a file usually represents a single location estimate at
a specific time. So, there’s very little we need to do in order to get our
<code>tbl_locs</code> into an acceptable structure.</p>
<div id="standard-column-names" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Standard Column Names</h3>
<p>One thing we can do, is to adjust the column names so there are no spaces or
hyphens. We can also drop everything to lower-case to avoid typos. To do this
we will create our own function, <code>make_names()</code>, which expands on the base
function <code>make.names()</code>. We also want to change the <code>date</code> column to a more appropriate and less confusing <code>date_time</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">## This function is also available within the crawlr package</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">make_names &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  new_names &lt;-<span class="st"> </span><span class="kw">make.names</span>(<span class="kw">colnames</span>(x))</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  new_names &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">.&quot;</span>, <span class="st">&quot;_&quot;</span>, new_names)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  new_names &lt;-<span class="st"> </span><span class="kw">tolower</span>(new_names)</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">  <span class="kw">colnames</span>(x) &lt;-<span class="st"> </span>new_names</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">  x</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb6-9" data-line-number="9"></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">tbl_locs &lt;-<span class="st"> </span><span class="kw">dir</span>(<span class="st">&#39;examples/data/&#39;</span>, <span class="st">&quot;*-Locations.csv&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="st">  </span>purrr<span class="op">::</span><span class="kw">map</span>(read_csv,<span class="dt">col_types =</span> my_cols) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="st">  </span><span class="kw">make_names</span>() <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">date_time =</span> date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid, date_time)</a></code></pre></div>
<p>At this point, our <code>tbl_locs</code> is pretty tidy and, other than a few final steps,
ready for input into the <code>crawl::crwMLE()</code> function. The <code>*-Histos.csv</code> file,
however, has a messy, horizontal structure and will require some tidying. The
<code>tidyr</code> package has a number of options that will help us. But, first let’s look
closer at the structure of a typical <code>*-Histos.csv</code>.</p>
</div>
<div id="tidy-a-messy-histos-file" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Tidy a Messy ‘Histos’ File</h3>
<p>Wildlife Computers provides a variety of data types within this file structure.
Because the details of each data type are subject to tag programming details, the
data structure places observations into a series of <code>Bin1, Bin2, ..., Bin72</code>
columns. What each <code>Bin#</code> column represents depends on the data type and how the
tags were programmed. For instance, a <code>Dive Depth</code> record represents the number
of dives with a maximum depth within the programmed depth bin range.
<code>Time At Depth (TAD)</code> represents the number of seconds spent within a particular
programmed depth bin range. Each record represents a period of time that is also
user programmable.</p>
<p>While this <em>messy</em> data structure is an efficient way of delivering the data to
users, it violates the principles of tidy data strucutes and presents a number
of data management and analysis challenges. We are going to focus on a process
for tidying the <code>Percent</code> or <code>1Percent</code> timeline data as this information can
be incorporated into the <code>crawl::crwMLE()</code> model fit. The same approach should
be adopted for other histogram record types and the <code>wcUtils</code>
<a href="https://github.com/jmlondon/wcUtils">package</a> provides a series of helper
functions developed specifically for this challenge.</p>
<p>The <code>Percent</code>/<code>1Percent</code> timeline data are presented within the <code>*-Histos.csv</code>
file structure as 24-hour observations — each record represents a 24-hour UTC
time period. Within the record, each <code>Bin#</code> represents an hour of the day from
<code>00</code> through <code>23</code>. The values recorded for each <code>Bin#</code> column represent the
percentage of that hour the tag was dry (out of the water). This data structure
violates the tidy principles of requiring each record represent a single
observation and that each column represent a single variable.</p>
<p>Let’s start by reading the data in to R with <code>readr::read_csv()</code> as before.
Note, we again rely on a custom <code>cols()</code> specification to insure data types
are properly set. And, since we are only interested in <code>Bin</code> columns 1:24, we
will select out the remaining columns.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">my_cols &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">cols</span>(</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="dt">DeployID =</span> readr<span class="op">::</span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="dt">Ptt =</span> readr<span class="op">::</span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="dt">DepthSensor =</span> readr<span class="op">::</span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="dt">Source =</span> readr<span class="op">::</span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  <span class="dt">Instr =</span> readr<span class="op">::</span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="dt">HistType =</span> readr<span class="op">::</span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="dt">Date =</span> readr<span class="op">::</span><span class="kw">col_datetime</span>(<span class="st">&quot;%H:%M:%S %d-%b-%Y&quot;</span>),</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  <span class="st">`</span><span class="dt">Time Offset</span><span class="st">`</span> =<span class="st"> </span>readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">  <span class="dt">Count =</span> readr<span class="op">::</span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">  <span class="dt">BadTherm =</span> readr<span class="op">::</span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">  <span class="dt">LocationQuality =</span> readr<span class="op">::</span><span class="kw">col_character</span>(),</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">  <span class="dt">Latitude =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  <span class="dt">Longitude =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  <span class="dt">NumBins =</span> readr<span class="op">::</span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">  <span class="dt">Sum =</span> readr<span class="op">::</span><span class="kw">col_integer</span>(),</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">  <span class="dt">Bin1 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin2 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin3 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">  <span class="dt">Bin4 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin5 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin6 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">  <span class="dt">Bin7 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin8 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin9 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">  <span class="dt">Bin10 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin11 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin12 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">  <span class="dt">Bin13 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin14 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin15 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">  <span class="dt">Bin16 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin17 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin18 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">  <span class="dt">Bin19 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin20 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin21 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">  <span class="dt">Bin22 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin23 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin24 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-25" data-line-number="25">  <span class="dt">Bin25 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin26 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin27 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-26" data-line-number="26">  <span class="dt">Bin28 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin29 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin30 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">  <span class="dt">Bin31 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin32 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin33 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">  <span class="dt">Bin34 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin35 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin36 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">  <span class="dt">Bin37 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin38 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin39 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-30" data-line-number="30">  <span class="dt">Bin40 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin41 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin42 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">  <span class="dt">Bin43 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin44 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin45 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-32" data-line-number="32">  <span class="dt">Bin46 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin47 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin48 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">  <span class="dt">Bin49 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin50 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin51 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-34" data-line-number="34">  <span class="dt">Bin52 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin53 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin54 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-35" data-line-number="35">  <span class="dt">Bin55 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin56 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin57 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-36" data-line-number="36">  <span class="dt">Bin58 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin59 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin60 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-37" data-line-number="37">  <span class="dt">Bin61 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin62 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin63 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-38" data-line-number="38">  <span class="dt">Bin64 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin65 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin66 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(),</a>
<a class="sourceLine" id="cb7-39" data-line-number="39">  <span class="dt">Bin67 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin68 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin69 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), </a>
<a class="sourceLine" id="cb7-40" data-line-number="40">  <span class="dt">Bin70 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin71 =</span> readr<span class="op">::</span><span class="kw">col_double</span>(), <span class="dt">Bin72 =</span> readr<span class="op">::</span><span class="kw">col_double</span>()</a>
<a class="sourceLine" id="cb7-41" data-line-number="41">)</a>
<a class="sourceLine" id="cb7-42" data-line-number="42"></a>
<a class="sourceLine" id="cb7-43" data-line-number="43">tbl_percent &lt;-<span class="st"> </span><span class="kw">dir</span>(<span class="st">&#39;examples/data/&#39;</span>, </a>
<a class="sourceLine" id="cb7-44" data-line-number="44">    <span class="st">&quot;*-Histos.csv&quot;</span>, </a>
<a class="sourceLine" id="cb7-45" data-line-number="45">    <span class="dt">full.names =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-46" data-line-number="46"><span class="st">  </span>purrr<span class="op">::</span><span class="kw">map</span>(read_csv,<span class="dt">col_types =</span> my_cols) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-47" data-line-number="47"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-48" data-line-number="48"><span class="st">  </span><span class="kw">make_names</span>() <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb7-49" data-line-number="49"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>(bin25<span class="op">:</span>bin72)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-50" data-line-number="50"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid, date)</a></code></pre></div>
</div>
<div id="gathering-data-with-tidyr" class="section level3">
<h3><span class="header-section-number">2.3.3</span> Gathering Data with <code>tidyr</code></h3>
<p>Now that our percent timeline data are in R, we can work to tidy the data
structure using the <code>tidyr::gather()</code> function. This function requires that we
provide character names for the <em>key</em> and <em>value</em> columns to create. We then
specify which columns will be <em>gathered</em> into those key-value paired columns.
In this case, our new columns will be <code>bin</code> and <code>percent_dry</code> and we will
<em>gather</em> the values from all of the columns that start with the character string
<em>bin</em>.</p>
<p>Since we know that each <code>bin</code> column represents an hour of the day, we can also
improve our data structure by changing the value of <code>date_hour</code> (note we rename
<code>date</code> to <code>date_hour</code>) to reflect this. We accomplish this by creating a simple
lookup table (tibble) that relates each <code>bin</code> column to the hour of day it
represents. The <code>dplyr::left_join()</code> function is used to match and merge this
with our <code>tbl_percent</code> and then we add the <code>hour</code> value to each <code>date_hour</code>
value with the <code>dplyr::mutate()</code> and <code>lubridate::hours()</code> functions.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">## Create a tbl_df that Relates Bin Columns to Day Hours</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">bins &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">bin =</span> <span class="kw">paste</span>(<span class="st">&quot;bin&quot;</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">24</span>,<span class="dt">sep =</span> <span class="st">&quot;&quot;</span>),<span class="dt">hour =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">23</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">## Chain Together Multiple Commands to Create Our Tidy Dataset</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">tbl_percent &lt;-<span class="st"> </span>tbl_percent <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">gather</span>(bin,percent_dry, <span class="kw">starts_with</span>(<span class="st">&#39;bin&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(bins, <span class="dt">by =</span> <span class="st">&quot;bin&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">date_hour =</span> date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">date_hour =</span> date_hour <span class="op">+</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">hours</span>(hour)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(deployid,date_hour,percent_dry) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(deployid, date_hour) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">summarize</span>(<span class="dt">percent_dry =</span> <span class="kw">mean</span>(percent_dry)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid,date_hour)</a></code></pre></div>
<p>Examining <code>tbl_percent</code>, we see that the layout is now more vertical and more
in line with tidy principles</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">tbl_percent</a></code></pre></div>
<pre><code>## # A tibble: 5,564 x 3
##    deployid            date_hour           percent_dry
##    &lt;chr&gt;               &lt;dttm&gt;                    &lt;dbl&gt;
##  1 PV2016_3019_16A0222 2016-09-21 02:00:00          NA
##  2 PV2016_3019_16A0222 2016-09-21 03:00:00          NA
##  3 PV2016_3019_16A0222 2016-09-21 04:00:00         100
##  4 PV2016_3019_16A0222 2016-09-21 05:00:00         100
##  5 PV2016_3019_16A0222 2016-09-21 06:00:00         100
##  6 PV2016_3019_16A0222 2016-09-21 07:00:00          30
##  7 PV2016_3019_16A0222 2016-09-21 08:00:00          20
##  8 PV2016_3019_16A0222 2016-09-21 09:00:00          10
##  9 PV2016_3019_16A0222 2016-09-21 10:00:00          10
## 10 PV2016_3019_16A0222 2016-09-21 11:00:00          10
## # ... with 5,554 more rows</code></pre>
</div>
<div id="visualizing-source-data" class="section level3">
<h3><span class="header-section-number">2.3.4</span> Visualizing Source Data</h3>
<p>To further explore our imported data and confirm there aren’t any remaining
issues to address, we can create visual representations of the data. The first
plot will rely on the spatial features within <code>ggplot2</code> and an extension to the
package, <code>ggspatial</code> to create a plot of the <code>tbl_locs</code> object. The second plot
will create a heatmap of <code>tbl_percent</code> values.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw">library</span>(ggspatial)</a></code></pre></div>
<p>The <code>sf</code> package provides the bulk of our spatial data framework. This is not
intended to be a full <code>sf</code> tutorial, but, where possible we will highlight a
few features and functions to explain the workflow. Users are encouraged to
spend significant time exploring and understanding the <code>sf</code> package through
existing documentation and several examples and blog posts available online.</p>
<p>Here, we are simply creating an <code>sf_locs</code> object via the <code>sf::st_as_sf()</code>
function. We specify the coordinate columns and then indicate the projection
of the data is geographic (lat/lon) as indicated by the <code>4326</code> epsg code.</p>
<p>In addition to points, it is often useful to organize the point data into
separate tracks for each deployment. The code to derive tracks from point data
within <code>sf</code> is a bit more complicated but is demonstrated below. The <code>sf_lines</code>
object is, essentially, a data frame with each row representing a single line
from a single deployment.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">sf_locs &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_as_sf</span>(tbl_locs, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>,<span class="st">&quot;latitude&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span>sf<span class="op">::</span><span class="kw">st_set_crs</span>(<span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">sf_lines &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid, date_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">  </span>sf<span class="op">::</span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span>sf<span class="op">::</span><span class="kw">st_cast</span>(<span class="st">&quot;MULTIPOINT&quot;</span>,<span class="dt">ids =</span> <span class="kw">as.integer</span>(<span class="kw">as.factor</span>(sf_locs<span class="op">$</span>deployid))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span>sf<span class="op">::</span><span class="kw">st_cast</span>(<span class="st">&quot;MULTILINESTRING&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">  </span>sf<span class="op">::</span><span class="kw">st_sf</span>(<span class="dt">deployid =</span> <span class="kw">as.factor</span>(<span class="kw">unique</span>(sf_locs<span class="op">$</span>deployid)))</a></code></pre></div>
<p>(ref:map-locs-fig-cap) An interactive map of observed satellite telemetry
locations from two harbor seals in the Aleutian Islands.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">esri_ocean &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;https://services.arcgisonline.com/arcgis/rest/services/&#39;</span>,</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">                     <span class="st">&#39;Ocean/World_Ocean_Base/MapServer/tile/${z}/${y}/${x}.jpeg&#39;</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="st">  </span><span class="kw">annotation_map_tile</span>(<span class="dt">type =</span> esri_ocean,<span class="dt">zoomin =</span> <span class="dv">1</span>,<span class="dt">progress =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="st">  </span><span class="kw">layer_spatial</span>(sf_lines, <span class="dt">size =</span> <span class="fl">0.75</span>,<span class="kw">aes</span>(<span class="dt">color =</span> deployid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">expand =</span> <span class="kw">expand_scale</span>(<span class="dt">mult =</span> <span class="kw">c</span>(.<span class="dv">6</span>, <span class="fl">.6</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Dark2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Observed Argos Location Paths&quot;</span>, </a>
<a class="sourceLine" id="cb13-11" data-line-number="11">          <span class="dt">subtitle =</span> <span class="st">&quot;harbor seals (n=2), Aleutian Islands, Alaska, USA&quot;</span>)</a></code></pre></div>
<div class="figure"><span id="fig:map-locs"></span>
<img src="images/map-locs-1.png" alt="(ref:map-locs-fig-cap)" width="100%" />
<p class="caption">
Figure 2.1: (ref:map-locs-fig-cap)
</p>
</div>
<p>(ref:percent-timeline-heatmap) Depiction of hourly percent dry observations for
two satellite tags deployed on harbor seals in the Aleutian Islands.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">p &lt;-<span class="st"> </span>tbl_percent <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">solar_hour =</span> date_hour <span class="op">+</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">dhours</span>(<span class="fl">11.5</span>),</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">                <span class="dt">solar_hour =</span> lubridate<span class="op">::</span><span class="kw">hour</span>(solar_hour)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lubridate<span class="op">::</span><span class="kw">date</span>(date_hour), </a>
<a class="sourceLine" id="cb14-6" data-line-number="6">                           <span class="dt">y =</span> solar_hour,</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">                           <span class="dt">fill =</span> percent_dry)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_tile</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">12</span>,<span class="dv">18</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_fill_viridis</span>(<span class="dt">name =</span> <span class="st">&quot;Percent Dry&quot;</span>,</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">                     <span class="dt">guide =</span> <span class="kw">guide_colorbar</span>(</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">                       <span class="dt">title.position =</span> <span class="st">&quot;bottom&quot;</span>,</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">                       <span class="dt">barwidth =</span> <span class="dv">25</span>, <span class="dt">barheight =</span> <span class="dv">1</span> )) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="st">  </span><span class="kw">facet_wrap</span>( <span class="op">~</span><span class="st"> </span>deployid, <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.title =</span> <span class="kw">element_text</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;local solar hour&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw">paste</span>(<span class="st">&quot;Haul-out Behavior by Local Solar Hour&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major.x =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb14-19" data-line-number="19">        <span class="dt">legend.position=</span><span class="st">&quot;bottom&quot;</span>) </a>
<a class="sourceLine" id="cb14-20" data-line-number="20">p</a></code></pre></div>
<div class="figure"><span id="fig:timeline-heatmaps"></span>
<img src="images/timeline-heatmaps-1.png" alt="(ref:percent-timeline-heatmap)" width="100%" />
<p class="caption">
Figure 2.2: (ref:percent-timeline-heatmap)
</p>
</div>
</div>
</div>
<div id="preparing-input-data-for-crawl" class="section level2">
<h2><span class="header-section-number">2.4</span> Preparing Input Data for <code>crawl</code></h2>
<p>At this point, the <code>tbl_locs</code> object represents the minimal source data
required to fit <code>crawl::crwMLE()</code>. In addition to including location estimates
in the model fit, one can also include an <em>activity</em> parameter. For harbor seals,
we can rely on the percent-timeline data as an indicator of activity — when
the tags are dry for most of an hour, the seal is likely hauled out and not
moving. The <code>crawl::crwMLE()</code> will interpret this as an indication that the
auto-correlation parameter should go to zero.</p>
<p>In this section, we will prepare <strong>two</strong> input objects for <code>crawl::crwMLE()</code>. The
first will be a spatial object (<code>sf_locs</code>) of location estimates that can be passed
directly. The second, will be a data.frame (<code>tbl_locs_activity</code>) that represents a merge between the location estimates and percent-timeline data.</p>
<div id="error-parameters-for-gps-data" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Error Parameters for GPS Data</h3>
<p>Many tags deployed on marine animals now include the option to collect GPS
quality location esimates in addition to Argos. <code>crawl::crwMLE()</code> relies on the
ellipse error parameters provide by Argos, so we need to fill in the GPS
locations with appropriate values. GPS locations from these tags are generally
expected to have an error radius of ~50m as long as the number of satellites
used for the estimate is greater than 4. Below, we will use the <code>dplyr::mutate()</code>
function to fill in these values. While we are at it, we will also remove any
<em>Argos</em> records that do not have associated error ellipse values.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">tbl_locs &lt;-<span class="st"> </span>tbl_locs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>(<span class="kw">is.na</span>(error_radius) <span class="op">&amp;</span><span class="st"> </span>type <span class="op">==</span><span class="st"> &#39;Argos&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    <span class="dt">error_semi_major_axis =</span> <span class="kw">ifelse</span>(type <span class="op">==</span><span class="st"> &#39;FastGPS&#39;</span>, <span class="dv">50</span>,</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">                                   error_semi_major_axis),</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">    <span class="dt">error_semi_minor_axis =</span> <span class="kw">ifelse</span>(type <span class="op">==</span><span class="st"> &#39;FastGPS&#39;</span>, <span class="dv">50</span>,</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">                                   error_semi_minor_axis),</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">    <span class="dt">error_ellipse_orientation =</span> <span class="kw">ifelse</span>(type <span class="op">==</span><span class="st"> &#39;FastGPS&#39;</span>, <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">                                       error_ellipse_orientation)</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">    )</a></code></pre></div>
</div>
<div id="known-locations" class="section level3">
<h3><span class="header-section-number">2.4.2</span> Known Locations</h3>
<p>In many cases, researchers are also knowledgable of the time and location
coordinates of animal release. The Wildlife Computers Data Portal allows this
to be entered and is included as a <em>User</em> record. The error radius one might
specify for this record is dependent on the release situation. In general,
it is best to over estimate this error radius. This record should be the first
location record in the dataset passed to <code>crawl::crwMLE()</code>.</p>
<p>Some researchers may also have additional date-times during the deployment
when the location is known (e.g. fur seals returning to a rookery between trips).
In these cases, <code>tbl_locs</code> can be augmented with additional <em>User</em> locations, but
the code example below will need to be customized for each situation. This code
example presumes there is just one <em>User</em> location and that corresponds to the
release/deployment start.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">tbl_locs &lt;-<span class="st"> </span>tbl_locs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">    <span class="dt">error_semi_major_axis =</span> <span class="kw">ifelse</span>(type <span class="op">==</span><span class="st"> &#39;User&#39;</span>, <span class="dv">500</span>,</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">                                   error_semi_major_axis),</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    <span class="dt">error_semi_minor_axis =</span> <span class="kw">ifelse</span>(type <span class="op">==</span><span class="st"> &#39;User&#39;</span>, <span class="dv">500</span>,</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">                                   error_semi_minor_axis),</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    <span class="dt">error_ellipse_orientation =</span> <span class="kw">ifelse</span>(type <span class="op">==</span><span class="st"> &#39;User&#39;</span>, <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">                                       error_ellipse_orientation)</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">    )</a>
<a class="sourceLine" id="cb16-10" data-line-number="10"></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">user_dt &lt;-<span class="st"> </span>tbl_locs <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">release_dt =</span> date_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(type <span class="op">==</span><span class="st"> &#39;User&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(deployid,release_dt)</a>
<a class="sourceLine" id="cb16-13" data-line-number="13"></a>
<a class="sourceLine" id="cb16-14" data-line-number="14">tbl_locs &lt;-<span class="st"> </span>tbl_locs <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(user_dt, <span class="dt">by =</span> <span class="st">&#39;deployid&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(date_time <span class="op">&gt;=</span><span class="st"> </span>release_dt) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>release_dt)</a>
<a class="sourceLine" id="cb16-16" data-line-number="16"></a>
<a class="sourceLine" id="cb16-17" data-line-number="17">tbl_locs <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(deployid) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(deployid,date_time,type) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">do</span>(<span class="kw">head</span>(.,<span class="dv">1</span>))</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
## # Groups:   deployid [2]
##   deployid            date_time           type 
##   &lt;chr&gt;               &lt;dttm&gt;              &lt;chr&gt;
## 1 PV2016_3019_16A0222 2016-09-21 05:08:00 User 
## 2 PV2016_3024_15A0909 2016-09-22 02:48:00 User</code></pre>
</div>
<div id="duplicate-times" class="section level3">
<h3><span class="header-section-number">2.4.3</span> Duplicate Times</h3>
<p>Argos data often contain near duplicate records. These are identified by location
estimates with the same date-time but differing coordinate or error values. In
theory, <code>crawl::crwMLE()</code> can handle these situations, but we have found it is
more reliable to <em>fix</em> these records. The first option for <em>fixing</em> the records
would be to eliminate one of the duplicate records. However, it is often not
possible to reliably identify which record is more appropriate to discard. For
this reason, we advocate adjusting the date-time value for one of the records and
increasing the value by 10 second. To facilitate this, we will rely on the
<code>xts::make.time.unique()</code> function.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">make_unique &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">  xts<span class="op">::</span><span class="kw">make.time.unique</span>(x<span class="op">$</span>date_time,<span class="dt">eps =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="kw">library</span>(xts)</a>
<a class="sourceLine" id="cb18-6" data-line-number="6"></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">tbl_locs &lt;-<span class="st"> </span>tbl_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid,date_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(deployid) <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">unique_time =</span> purrr<span class="op">::</span><span class="kw">map</span>(data, make_unique)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>date_time) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">date_time =</span> unique_time)</a></code></pre></div>
</div>
<div id="course-speed-filter" class="section level3">
<h3><span class="header-section-number">2.4.4</span> Course Speed Filter</h3>
<p>This step is optional, but it is very common for Argos data to include obviously
wrong locations (locations that are hundreds of kilometers away from the study area).
Including such obviously wrong locations in the analysis can result in unexpected
issues or problems fitting. For this reason, we recommend a course speed filter
to remove these obviously wrong locations. A typical speed filter might use a
value of 2.5 m/s as a biologically reasonable value for pinnipeds. For this
application, we will use 7.5 m/s and rely on the <code>argosfilter</code> package.</p>
<p>The example code below follows a typical split-apply-combine approach using
functions from the <code>dplyr</code>, <code>tidyr</code>, and <code>purrr</code> packages. This analysis can
be run in series, however, the process lends itself nicely to parallel processing.
The <code>parallel</code> package (included with the distribution of R) would be one option
for taking advantage of multiple processors. However, we want to maintain the
<code>purrr</code> and nested column tibble data structure. The <code>multidplyr</code> package is
in development and available for install via the <code>devtools</code> package and source
code hosted on GitHub.</p>
<p>This is not intended to be a <code>multidplyr</code> tutorial, so some details are left
out. That said, many processes in analysis of animal movement are setup nicely
for parallel processing. We encourage anyone who is doing movement analysis on
datasets with a large number of animals to spend some time learning about the
various parallel processing options within R.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">library</span>(purrr)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="kw">library</span>(furrr)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">future<span class="op">::</span><span class="kw">plan</span>(multiprocess)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">tbl_locs &lt;-<span class="st"> </span>tbl_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid, date_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(deployid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">nest</span>() </a>
<a class="sourceLine" id="cb19-10" data-line-number="10"></a>
<a class="sourceLine" id="cb19-11" data-line-number="11">tbl_locs <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1     2</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">tbl_locs &lt;-<span class="st"> </span>tbl_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">filtered =</span> furrr<span class="op">::</span><span class="kw">future_map</span>(data, <span class="op">~</span><span class="st"> </span>argosfilter<span class="op">::</span><span class="kw">sdafilter</span>(</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">    <span class="dt">lat =</span> .x<span class="op">$</span>latitude,</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">    <span class="dt">lon =</span> .x<span class="op">$</span>longitude,</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">    <span class="dt">dtime =</span> .x<span class="op">$</span>date_time,</a>
<a class="sourceLine" id="cb21-6" data-line-number="6">    <span class="dt">lc =</span> .x<span class="op">$</span>quality,</a>
<a class="sourceLine" id="cb21-7" data-line-number="7">    <span class="dt">vmax =</span> <span class="fl">7.5</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8">  ))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(filtered <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;not&quot;</span>, <span class="st">&quot;end_location&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>filtered) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid,date_time)</a>
<a class="sourceLine" id="cb21-13" data-line-number="13"></a>
<a class="sourceLine" id="cb21-14" data-line-number="14">tbl_locs <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1  3787</code></pre>
</div>
<div id="create-a-spatial-object" class="section level3">
<h3><span class="header-section-number">2.4.5</span> Create a Spatial Object</h3>
<p>There are now two package frameworks within R for describing spatial data: <code>sp</code>
and <code>sf</code>. The <code>sp</code> package has been the defacto standard for spatial data in R
and has widespread support in a number of additional packages. The <code>sf</code> package
is new and still in active development. However, the <code>sf</code> package is based on
the more open <em>simple features</em> standard for spatial data. For this reason, and
others, many in the R community feel <code>sf</code> is the future of spatial data in R.</p>
<p>In the previous section, our <code>leaflet</code> map relied on input of an <code>sf</code> object.</p>
<p>The <code>crawl::crwMLE()</code> can accept either a <em>SpatialPointsDataFrame</em> from the
<code>sp</code> package or an <em>sf</em> data.frame of <em>POINT</em> geometry types. Here, we will
focus on the <code>sf</code> package.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">sf_locs &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_as_sf</span>(tbl_locs, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>,<span class="st">&quot;latitude&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="st">  </span>sf<span class="op">::</span><span class="kw">st_set_crs</span>(<span class="dv">4326</span>)</a></code></pre></div>
<p>Earlier versions of <code>crawl</code> allowed users to pass geographic coordinates (
e.g. latitude, longitude). However, relying on geographic coordinates presents some
problems (e.g. crossing 180 or 0) and requires some assumptions to convert
decimal degrees into meters — the units for the provided error ellipses.
Because of these issues, all data should be provided to the <code>crawl::crwMLE()</code>
as projected coordinates in meter units. Which projection users choose is
dependent upon their study area. For these data, we will go with the <em>North Pole
LAEA Bering Sea</em> projection. This projection is often abbreciated by the epsg
code of 3571. If you don’t know the epsg code for the preferred projection in
your study area, a the <a href="http://spatialreference.org/">spatial reference</a>
website provides a comprehensive catalog of projections and epsg codes.</p>
<p>The <code>sf::transform()</code> function provides an easy method for transforming our
coordinates. After, we can examine the geometry and confirm our coordinate
units are in meters.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">sf_locs &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_transform</span>(sf_locs, <span class="dv">3571</span>)</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"></a>
<a class="sourceLine" id="cb24-3" data-line-number="3">sf<span class="op">::</span><span class="kw">st_geometry</span>(sf_locs)</a></code></pre></div>
<pre><code>## Geometry set for 3787 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -510531.2 ymin: -4094081 xmax: -369854 ymax: -4034591
## epsg (SRID):    3571
## proj4string:    +proj=laea +lat_0=90 +lon_0=180 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs
## First 5 geometries:</code></pre>
<p>At this point, <code>sf_locs</code> is a valid format for input to <code>crawl::crwMLE()</code>.
However, if you want to include the percent-timeline data as an <em>activity</em>
parameter, there’s bit more work to do.</p>
</div>
<div id="merging-with-activity-data" class="section level3">
<h3><span class="header-section-number">2.4.6</span> Merging with Activity Data</h3>
<p>Since our <em>activity</em> data represent hourly records, we need to create a
<code>date_hour</code> field within <code>tbl_locs</code> as the basis for our join. While we are at
it, we’ll translate the simple feature geometry
for our point coordinates into an <code>x</code> and <code>y</code> column (note the use of a local
function <code>sfc_as_cols()</code> to facilitate this). This addition of an <code>x</code> and <code>y</code>
column is mostly a convenience function that may not be needed in future versions.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">sfc_as_cols &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>)) {</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">inherits</span>(x,<span class="st">&quot;sf&quot;</span>) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">inherits</span>(sf<span class="op">::</span><span class="kw">st_geometry</span>(x),<span class="st">&quot;sfc_POINT&quot;</span>))</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">  ret &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_coordinates</span>(x)</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">  ret &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw">as_tibble</span>(ret)</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">  <span class="kw">stopifnot</span>(<span class="kw">length</span>(names) <span class="op">==</span><span class="st"> </span><span class="kw">ncol</span>(ret))</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">  x &lt;-<span class="st"> </span>x[ , <span class="op">!</span><span class="kw">names</span>(x) <span class="op">%in%</span><span class="st"> </span>names]</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">  ret &lt;-<span class="st"> </span><span class="kw">setNames</span>(ret,names)</a>
<a class="sourceLine" id="cb26-8" data-line-number="8">  dplyr<span class="op">::</span><span class="kw">bind_cols</span>(x,ret)</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb26-10" data-line-number="10"></a>
<a class="sourceLine" id="cb26-11" data-line-number="11">sf_locs &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date_hour =</span> lubridate<span class="op">::</span><span class="kw">floor_date</span>(date_time,<span class="st">&#39;hour&#39;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="st">  </span><span class="kw">arrange</span>(deployid, date_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-14" data-line-number="14"><span class="st">  </span><span class="kw">sfc_as_cols</span>()</a></code></pre></div>
<p>We also need to make sure our <em>activity</em> data includes all possible hours during
the deployment. There are often missing days where the percent-timeline data
was not transmitted back and so are not included in the source data. We rely on
the <code>tidyr::complete()</code> function to expand our <code>date_hour</code> field. This will
results in <code>NA</code> values for <code>percent_dry</code>. We will set these values to <em>33</em>
because it will allow some level of correlated movement during these missing
periods. Another option would be to use the <code>zoo::na_locf()</code> function to carry
the last ovserved value forward.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">tbl_percent &lt;-<span class="st"> </span>tbl_percent <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(deployid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">complete</span>(<span class="dt">date_hour =</span> <span class="kw">full_seq</span>(date_hour, 3600L)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">percent_dry =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(percent_dry), <span class="dv">33</span>, percent_dry)) </a></code></pre></div>
<p>In addition to joining these two tables together, we also need to make sure
the <em>activity</em> data doesn’t extend beyond the range of date-time values for
observed locations.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">trim_deployment &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">  dplyr<span class="op">::</span><span class="kw">filter</span>(x, <span class="kw">between</span>(date_hour,</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">                        lubridate<span class="op">::</span><span class="kw">floor_date</span>(<span class="kw">min</span>(date_time,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>),<span class="st">&#39;hour&#39;</span>),</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">                        <span class="kw">max</span>(date_time,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb28-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"></a>
<a class="sourceLine" id="cb28-7" data-line-number="7">tbl_locs_activity &lt;-<span class="st"> </span>tbl_percent <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(sf_locs, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;deployid&quot;</span>,<span class="st">&quot;date_hour&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-9" data-line-number="9"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">activity =</span> <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>percent_dry<span class="op">/</span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(deployid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-12" data-line-number="12"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">data =</span> purrr<span class="op">::</span><span class="kw">map</span>(data,trim_deployment)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-13" data-line-number="13"><span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-14" data-line-number="14"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">date_time =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(date_time),date_hour,date_time),</a>
<a class="sourceLine" id="cb28-15" data-line-number="15">                <span class="dt">date_time =</span> lubridate<span class="op">::</span><span class="kw">as_datetime</span>(date_time)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-16" data-line-number="16"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>geometry) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-17" data-line-number="17"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(deployid,date_time) </a></code></pre></div>
</div>
</div>
<div id="determining-your-model-parameters" class="section level2">
<h2><span class="header-section-number">2.5</span> Determining Your Model Parameters</h2>
<div id="install-latest-version-of-crawl" class="section level3">
<h3><span class="header-section-number">2.5.1</span> Install Latest Version of <code>crawl</code></h3>
<p>The most stable and reliable version of <code>crawl</code> is available on CRAN. However,
new features and improvements are often available within the <strong>development</strong>
version available through GitHub. To install the development version we will
rely on the <code>devtools::install_github()</code> function.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&#39;NMML/crawl&#39;</span>,<span class="dt">ref=</span><span class="st">&#39;devel&#39;</span>)</a></code></pre></div>
</div>
<div id="create-a-nested-data-structure" class="section level3">
<h3><span class="header-section-number">2.5.2</span> Create a Nested Data Structure</h3>
<p>We now have two objects: <code>sf_locs</code> and <code>tbl_locs_activity</code>. The first step is
to <em>nest</em> each of our objects by <code>deployid</code> so we can take advantage of list
columns when fitting multiple deployments at once. We will group by <code>deployid</code>
and then call <code>tidyr::nest()</code>. For <code>sf_locs</code> we need to convert back into an
<code>sf</code> object after the group by and nesting. Note, we are also setting up the
required cluster partitioning steps for the <code>multidplyr</code> package like we did
with the speed filtering earlier.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">future<span class="op">::</span><span class="kw">plan</span>(multisession)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">sf_locs &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(deployid) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(date_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">data =</span> furrr<span class="op">::</span><span class="kw">future_map</span>(data,sf<span class="op">::</span>st_as_sf))</a>
<a class="sourceLine" id="cb30-6" data-line-number="6"></a>
<a class="sourceLine" id="cb30-7" data-line-number="7">tbl_locs_activity &lt;-<span class="st"> </span>tbl_locs_activity <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(deployid) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(date_time) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-9" data-line-number="9"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">nest</span>()</a></code></pre></div>
<p>This <em>nested</em> data structure and the use of list-columns is a relatively
new concept for R. This approach is all part of the <em>tidyverse</em> dialect
and, instead of making this a full tutoriala on <code>purrr::map()</code>,
<code>tidyr::nest()</code>, etc. I suggest reading up on various tutorials available
on the web and playing around with other examples.</p>
</div>
<div id="create-ellipse-error-columns" class="section level3">
<h3><span class="header-section-number">2.5.3</span> Create Ellipse Error Columns</h3>
<p>The data in this example are from recent Argos deployments and, thus, include
error ellipse information determined from the Kalman filter processing that
has been available since 2011. This ellipse information provides a
significant improvement to modeling animal movement because it provides
specific information on the error associated with each location estimate. The
<code>crawl::argosDiag2Cov()</code> function returns 3 columns we can then bind back into
our data.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">sf_locs &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">    <span class="dt">diag =</span> purrr<span class="op">::</span><span class="kw">map</span>(data, <span class="op">~</span><span class="st"> </span>crawl<span class="op">::</span><span class="kw">argosDiag2Cov</span>(</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">                      .x<span class="op">$</span>error_semi_major_axis, </a>
<a class="sourceLine" id="cb31-5" data-line-number="5">                      .x<span class="op">$</span>error_semi_minor_axis, </a>
<a class="sourceLine" id="cb31-6" data-line-number="6">                      .x<span class="op">$</span>error_ellipse_orientation)),</a>
<a class="sourceLine" id="cb31-7" data-line-number="7">    <span class="dt">data =</span> purrr<span class="op">::</span><span class="kw">map2</span>(data,diag,bind_cols)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>diag)</a>
<a class="sourceLine" id="cb31-9" data-line-number="9"></a>
<a class="sourceLine" id="cb31-10" data-line-number="10">tbl_locs_activity &lt;-<span class="st"> </span>tbl_locs_activity <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-11" data-line-number="11"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb31-12" data-line-number="12">    <span class="dt">diag =</span> purrr<span class="op">::</span><span class="kw">map</span>(data, <span class="op">~</span><span class="st"> </span>crawl<span class="op">::</span><span class="kw">argosDiag2Cov</span>(</a>
<a class="sourceLine" id="cb31-13" data-line-number="13">                      .x<span class="op">$</span>error_semi_major_axis, </a>
<a class="sourceLine" id="cb31-14" data-line-number="14">                      .x<span class="op">$</span>error_semi_minor_axis, </a>
<a class="sourceLine" id="cb31-15" data-line-number="15">                      .x<span class="op">$</span>error_ellipse_orientation)),</a>
<a class="sourceLine" id="cb31-16" data-line-number="16">    <span class="dt">data =</span> purrr<span class="op">::</span><span class="kw">map2</span>(data,diag,bind_cols)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-17" data-line-number="17"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>diag)</a></code></pre></div>
</div>
<div id="create-model-parameters" class="section level3">
<h3><span class="header-section-number">2.5.4</span> Create Model Parameters</h3>
<p>We will create a function that will create our initial parameters (<code>init</code>)
that <code>crawl::crwMLE()</code> requires. This is a list of starting values for the mean
and variance-covariance for the initial state of the model. When choosing the
initial parameters, it is typical to have the mean centered on the first
observation with zero velocity. <em>a</em> is the starting location for the model –
the first known coordinate; and P is a 4x4 var-cov matrix that specifies
the error (in projected units) for the initial coordinates.</p>
<blockquote>
<p>Note that this <code>init_params()</code> functiion can either extract the coordinate
values from the <code>x</code> and <code>y</code> columns we created previously or from the simple
features geometry.</p>
</blockquote>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">init_params &lt;-<span class="st"> </span><span class="cf">function</span>(d) {</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">  <span class="cf">if</span> (<span class="kw">any</span>(<span class="kw">colnames</span>(d) <span class="op">==</span><span class="st"> &quot;x&quot;</span>) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">any</span>(<span class="kw">colnames</span>(d) <span class="op">==</span><span class="st"> &quot;y&quot;</span>)) {</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">  ret &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="kw">c</span>(d<span class="op">$</span>x[<span class="dv">1</span>], <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb32-4" data-line-number="4">                    d<span class="op">$</span>y[<span class="dv">1</span>], <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb32-5" data-line-number="5">              <span class="dt">P =</span> <span class="kw">diag</span>(<span class="kw">c</span>(<span class="dv">10</span> <span class="op">^</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">10</span> <span class="op">^</span><span class="st"> </span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb32-6" data-line-number="6">                         <span class="dv">10</span> <span class="op">^</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">10</span> <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb32-7" data-line-number="7">  } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">inherits</span>(d,<span class="st">&quot;sf&quot;</span>)) {</a>
<a class="sourceLine" id="cb32-8" data-line-number="8">    ret &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="kw">c</span>(sf<span class="op">::</span><span class="kw">st_coordinates</span>(d)[[<span class="dv">1</span>,<span class="dv">1</span>]], <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb32-9" data-line-number="9">                      sf<span class="op">::</span><span class="kw">st_coordinates</span>(d)[[<span class="dv">1</span>,<span class="dv">2</span>]], <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb32-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb32-11" data-line-number="11">  ret</a>
<a class="sourceLine" id="cb32-12" data-line-number="12">} </a></code></pre></div>
<p>In addition to specifying the initial state, we need to provide a vector
specifying which parameters will be fixed. Any values specified as <em>NA</em> will be
estimated by the model. This information is passed to <code>crawl::crwMLE()</code> as the
functional argument <code>fixPar</code>. The general order for <code>fixPar</code> is location error
variance parameters (e.g. ellipse, location quality), followed by <em>sigma</em> and
<em>beta</em> and, then, the <em>activity</em> parameter.</p>
<p>For this example, the first two values in the vector are set to 1 as we are
providing the error structure with the ellipse information. The thrid value in
the vector is <em>sigma</em> and this is almost always set to <em>NA</em>. The fourth value is
<em>beta</em> which is the auto-correlation parameter. This is also, typically, set to
<em>NA</em> as we want to estimate this. However, for some limited/challenging
datasets, you may need to fix this value in order to force a model fit. If an
activity parameter is provided, then a fifth value is inlcuded in <code>fixPar</code> and
should be set to <em>0</em>.</p>
<div id="argos-location-quality-errors" class="section level4">
<h4><span class="header-section-number">2.5.4.1</span> Argos Location Quality Errors</h4>
<blockquote>
<p>It is important to note that if ellipse error information is available, then
this should be preferred over use of the location quality classes.</p>
</blockquote>
<p>In cases where the ellipse error structure is not available, we need to rely on
the location quality classes provided by CLS/Argos for each location estimate.
While CLS/Argos do provide guidelines for error associated with location classes
3, 2, and 1, there is no direct way to translate these error guidelines into
standard error distributions. Additionally, these error values have been shown
to generally underestimate the error associated with location estimates from
marine species. Each user and each research project should decide on values that
best fit their needs and their regions.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">order_lc &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">  x<span class="op">$</span>quality =<span class="st"> </span><span class="kw">factor</span>(x<span class="op">$</span>quality, </a>
<a class="sourceLine" id="cb33-3" data-line-number="3">                     <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;3&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;1&quot;</span>,<span class="st">&quot;0&quot;</span>,<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>))</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">  <span class="kw">return</span>(x)</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb33-6" data-line-number="6"></a>
<a class="sourceLine" id="cb33-7" data-line-number="7">sf_locs &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb33-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">data =</span> furrr<span class="op">::</span><span class="kw">future_map</span>(data,order_lc))</a></code></pre></div>
<p>There are two options for incorporating the location quality errors into <code>crawl</code>.</p>
<ol style="list-style-type: decimal">
<li>Fix the variance parameters for the first three location quality classes</li>
<li>Provide a prior distribution for each of the location quality classes</li>
</ol>
<p>The first option is to fix the variance parameters for the first three
location quality classes and then allow the model to estimate the
remaining values. We do this via the <code>fixPar</code> argument.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">## example code for specifying `fixPar` with fixed values for 3, 2, and 1</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">sf_locs &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb34-4" data-line-number="4">    <span class="dt">fixpar =</span> <span class="kw">rep</span>(</a>
<a class="sourceLine" id="cb34-5" data-line-number="5">      <span class="kw">list</span>(<span class="kw">c</span>(<span class="kw">log</span>(<span class="dv">250</span>), <span class="kw">log</span>(<span class="dv">500</span>), <span class="kw">log</span>(<span class="dv">1500</span>), <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)),</a>
<a class="sourceLine" id="cb34-6" data-line-number="6">      <span class="kw">nrow</span>(.)</a>
<a class="sourceLine" id="cb34-7" data-line-number="7">    )</a>
<a class="sourceLine" id="cb34-8" data-line-number="8">  )</a></code></pre></div>
<p>The first 6 elements in the vector provided to the <code>fixPar</code> argument represent the
6 location quality classes (ordered from 3 to A). In the ellipse version of this
approach, the first two elements represented in the ellipse error for <code>x</code> and <code>y</code>.
Here we will presume the variance for our error is the same in both <code>x</code> and <code>y</code>.
Note the values are provided as log-transformed.</p>
<p>It is also important that the location quality column in the data be set as a
factor variable and that the levels be ordered correctly.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">order_lc &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb35-2" data-line-number="2">  x<span class="op">$</span>quality =<span class="st"> </span><span class="kw">factor</span>(x<span class="op">$</span>quality, </a>
<a class="sourceLine" id="cb35-3" data-line-number="3">                     <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;3&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;1&quot;</span>,<span class="st">&quot;0&quot;</span>,<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>))</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">  <span class="kw">return</span>(x)</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb35-6" data-line-number="6"></a>
<a class="sourceLine" id="cb35-7" data-line-number="7">sf_locs &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-8" data-line-number="8"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">data =</span> purrr<span class="op">::</span><span class="kw">map</span>(data,order_lc))</a></code></pre></div>
<p>The second option is to provide a prior distribution for each of the location
quality classes. The <code>crawl::crwMLE()</code> function accepts a function for the
‘prior’ argument. In this example, we provide a normal distribution of the
log-transformed error. The standard error of 0.2</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">prior &lt;-<span class="st">  </span><span class="cf">function</span>(p) { </a>
<a class="sourceLine" id="cb36-2" data-line-number="2">    <span class="kw">dnorm</span>(p[<span class="dv">1</span>], <span class="kw">log</span>(<span class="dv">250</span>), <span class="fl">0.2</span> , <span class="dt">log =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="st">      </span><span class="kw">dnorm</span>(p[<span class="dv">2</span>], <span class="kw">log</span>(<span class="dv">500</span>), <span class="fl">0.2</span> , <span class="dt">log =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="st">      </span><span class="kw">dnorm</span>(p[<span class="dv">3</span>], <span class="kw">log</span>(<span class="dv">1500</span>), <span class="fl">0.2</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="st">      </span><span class="kw">dnorm</span>(p[<span class="dv">4</span>], <span class="kw">log</span>(<span class="dv">2500</span>), <span class="fl">0.4</span> , <span class="dt">log =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="st">      </span><span class="kw">dnorm</span>(p[<span class="dv">5</span>], <span class="kw">log</span>(<span class="dv">2500</span>), <span class="fl">0.4</span> , <span class="dt">log =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="st">      </span><span class="kw">dnorm</span>(p[<span class="dv">6</span>], <span class="kw">log</span>(<span class="dv">2500</span>), <span class="fl">0.4</span> , <span class="dt">log =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="st">      </span><span class="co"># skip p[7] as we won&#39;t provide a prior for sigma</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9"><span class="st">      </span><span class="kw">dnorm</span>(p[<span class="dv">8</span>], <span class="dv">-4</span>, <span class="dv">2</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb36-10" data-line-number="10">}</a></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">qual_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">data.frame</span>( <span class="dt">x =</span> <span class="kw">exp</span>(<span class="kw">rnorm</span>(<span class="dv">200</span>,<span class="kw">log</span>(<span class="dv">250</span>),<span class="fl">0.2</span>)))</a>
<a class="sourceLine" id="cb37-2" data-line-number="2"><span class="kw">ggplot</span>(<span class="dt">data =</span> qual_<span class="dv">3</span>, <span class="kw">aes</span>(<span class="dt">x=</span>x)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">20</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Prior Distribution for Location Quality 3&quot;</span>)</a></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-29"></span>
<img src="images/unnamed-chunk-29-1.png" alt="A histogram representing a prior distribution (normal) for location quality class 3 with a mean of log(250) and standard error of 0.2." width="672" />
<p class="caption">
Figure 2.3: A histogram representing a prior distribution (normal) for location quality class 3 with a mean of log(250) and standard error of 0.2.
</p>
</div>

<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">qual_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">data.frame</span>( <span class="dt">x =</span> <span class="kw">exp</span>(<span class="kw">rnorm</span>(<span class="dv">200</span>,<span class="kw">log</span>(<span class="dv">1500</span>),<span class="fl">0.2</span>)))</a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="kw">ggplot</span>(<span class="dt">data =</span> qual_<span class="dv">2</span>, <span class="kw">aes</span>(<span class="dt">x=</span>x)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">20</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Prior Distribution for Location Quality 1&quot;</span>)</a></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-30"></span>
<img src="images/unnamed-chunk-30-1.png" alt="(ref:histogram-qual-1-prior)" width="672" />
<p class="caption">
Figure 2.4: (ref:histogram-qual-1-prior)
</p>
</div>

<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">qual_B &lt;-<span class="st"> </span><span class="kw">data.frame</span>( <span class="dt">x =</span> <span class="kw">exp</span>(<span class="kw">rnorm</span>(<span class="dv">200</span>,<span class="kw">log</span>(<span class="dv">2500</span>),<span class="fl">0.4</span>)))</a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw">ggplot</span>(<span class="dt">data =</span> qual_B, <span class="kw">aes</span>(<span class="dt">x=</span>x)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">20</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb39-3" data-line-number="3"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Prior Distribution for Location Quality B&quot;</span>)</a></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-31"></span>
<img src="images/unnamed-chunk-31-1.png" alt="A histogram representing a prior distribution (normal) for location quality class B with a mean of log(2500) and standard error of 0.4." width="672" />
<p class="caption">
Figure 2.5: A histogram representing a prior distribution (normal) for location quality class B with a mean of log(2500) and standard error of 0.4.
</p>
</div>

<p>In addition to prior distributions for the location quality classes, we can
also provide a prior distribution for the <em>beta</em> parameter. We suggest a normal
distribution with a mean of -4 and a standard deviation of 2. This encourages the
model to fit a smoother track unless the data warrant a rougher, more Brownian,
path.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">beta &lt;-<span class="st"> </span><span class="kw">data.frame</span>( <span class="dt">x =</span> <span class="kw">exp</span>(<span class="kw">rnorm</span>(<span class="dv">200</span>,<span class="op">-</span><span class="dv">4</span>,<span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="kw">ggplot</span>(<span class="dt">data =</span> beta, <span class="kw">aes</span>(<span class="dt">x=</span>x)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">20</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Prior Distribution for Beta Parameter&quot;</span>)</a></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-32"></span>
<img src="images/unnamed-chunk-32-1.png" alt="A histogram representing a prior distribution (normal) for the beta parameter with a mean of -4 and standard error of 2." width="672" />
<p class="caption">
Figure 2.6: A histogram representing a prior distribution (normal) for the beta parameter with a mean of -4 and standard error of 2.
</p>
</div>

</div>
<div id="prior-distributions-vs-fixed-values-and-constraints" class="section level4">
<h4><span class="header-section-number">2.5.4.2</span> Prior Distributions vs Fixed Values and Constraints</h4>
<p>Previous documentation and examples that described a setup for ‘crawl’ often
suggested users implement a mixed approach by providing both fixed values and
constraints to optimize the fit and increase the model’s ability to converge
with limited/challenging data. We now suggest users rely on prior distributions
to achieve a similar intent but provide the model more flexibility. Users should
feel free to explore various distributions and approaches for describing the
priors (e.g. laplace, log-normal) based on their data and research questions.</p>
<p>Those documents also often suggested fixing the <em>beta</em> parameter to 4 as the
best approach to encourage challenging datasets to fit. This, essentially,
forced the fit toward Brownian movement. We now suggest users rely on the prior
distribution centered on -4 (smoother fit) and, if needed, fix the <em>beta</em>
parameter to -4. Only fix the parameter to 4 as a final resort.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">sf_locs &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb41-3" data-line-number="3">                <span class="dt">fixpar =</span> <span class="kw">rep</span>(</a>
<a class="sourceLine" id="cb41-4" data-line-number="4">                  <span class="kw">list</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>)),</a>
<a class="sourceLine" id="cb41-5" data-line-number="5">                       <span class="kw">nrow</span>(.)</a>
<a class="sourceLine" id="cb41-6" data-line-number="6">                  )</a>
<a class="sourceLine" id="cb41-7" data-line-number="7">  )</a>
<a class="sourceLine" id="cb41-8" data-line-number="8"></a>
<a class="sourceLine" id="cb41-9" data-line-number="9">tbl_locs_activity &lt;-<span class="st"> </span>tbl_locs_activity <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb41-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">fixpar =</span> <span class="kw">rep</span>(</a>
<a class="sourceLine" id="cb41-11" data-line-number="11">                  <span class="kw">list</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="dv">0</span>)),</a>
<a class="sourceLine" id="cb41-12" data-line-number="12">                       <span class="kw">nrow</span>(.)</a>
<a class="sourceLine" id="cb41-13" data-line-number="13">                  )</a>
<a class="sourceLine" id="cb41-14" data-line-number="14">  )</a></code></pre></div>
</div>
</div>
</div>
<div id="fitting-with-crawlcrwmle" class="section level2">
<h2><span class="header-section-number">2.6</span> Fitting with <code>crawl::crwMLE()</code></h2>
<p>The <code>crawl::crwMLE()</code> function is the workhorse for fitting our observed data to
a continuous-time correlated random walk model. At this point, we have our data
structure setup and we’ve established our initial parameters, specified fixed
values for any parameters we will not estimate, and provided some constraints
on those parameter estimates.</p>
<p>Instead of calling <code>crawl::crwMLE()</code> directly, we will create a wrapper function
that will work better with our <em>tidy</em> approach. It also allows us to make
sequencial calls to <code>crawl::crwMLE()</code> that adjust parameters in cases where the
fit fails.</p>
<p>A few other aspects about our wrapper function to note. We pass our observed
data in as <code>d</code> and then the parameters <code>fixpar</code>, and <code>constr</code>.
Additionally, we can specify <code>tryBrownian = FALSE</code> if we don’t want the model
to fit with Brownian motion as the final try.</p>
<p>Each of the prior functions is specified within the function and the function
cycles through a for loop of calls to <code>crawl::crwMLE()</code> with each prior. Note,
the first prior value is <em>NULL</em> to specify our first model fit try is without
any prior.</p>
<p>Our wrapper function also checks the observed data, <code>d</code>, for any <em>activity</em>
column to determine whether activity parameter should be included in the
model fit.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">fit_crawl &lt;-<span class="st"> </span><span class="cf">function</span>(d, fixpar) {</a>
<a class="sourceLine" id="cb42-2" data-line-number="2"></a>
<a class="sourceLine" id="cb42-3" data-line-number="3">## if relying on a prior for location quality</a>
<a class="sourceLine" id="cb42-4" data-line-number="4">## replace this with the function described previously</a>
<a class="sourceLine" id="cb42-5" data-line-number="5">prior &lt;-<span class="st"> </span><span class="cf">function</span>(p) {</a>
<a class="sourceLine" id="cb42-6" data-line-number="6">  <span class="kw">dnorm</span>(p[<span class="dv">2</span>], <span class="dv">-4</span>, <span class="dv">2</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb42-7" data-line-number="7">} </a>
<a class="sourceLine" id="cb42-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb42-9" data-line-number="9">fit &lt;-<span class="st"> </span>crawl<span class="op">::</span><span class="kw">crwMLE</span>(</a>
<a class="sourceLine" id="cb42-10" data-line-number="10">  <span class="dt">mov.model =</span>  <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb42-11" data-line-number="11">  <span class="dt">err.model =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb42-12" data-line-number="12">      <span class="dt">x =</span>  <span class="op">~</span><span class="st"> </span>ln.sd.x <span class="op">-</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb42-13" data-line-number="13">      <span class="dt">y =</span>  <span class="op">~</span><span class="st"> </span>ln.sd.y <span class="op">-</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb42-14" data-line-number="14">      <span class="dt">rho =</span>  <span class="op">~</span><span class="st"> </span>error.corr</a>
<a class="sourceLine" id="cb42-15" data-line-number="15">    ),</a>
<a class="sourceLine" id="cb42-16" data-line-number="16">  <span class="cf">if</span> (<span class="kw">any</span>(<span class="kw">colnames</span>(d) <span class="op">==</span><span class="st"> &quot;activity&quot;</span>)) {</a>
<a class="sourceLine" id="cb42-17" data-line-number="17">        activity &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span><span class="kw">I</span>(activity)</a>
<a class="sourceLine" id="cb42-18" data-line-number="18">      } <span class="cf">else</span> {activity &lt;-<span class="st"> </span><span class="ot">NULL</span>},</a>
<a class="sourceLine" id="cb42-19" data-line-number="19">  <span class="dt">fixPar =</span> fixpar,</a>
<a class="sourceLine" id="cb42-20" data-line-number="20">  <span class="dt">data =</span> d,</a>
<a class="sourceLine" id="cb42-21" data-line-number="21">  <span class="dt">method =</span> <span class="st">&quot;Nelder-Mead&quot;</span>,</a>
<a class="sourceLine" id="cb42-22" data-line-number="22">  <span class="dt">Time.name =</span> <span class="st">&quot;date_time&quot;</span>,</a>
<a class="sourceLine" id="cb42-23" data-line-number="23">  <span class="dt">prior =</span> prior,</a>
<a class="sourceLine" id="cb42-24" data-line-number="24">  <span class="dt">attempts =</span> <span class="dv">8</span>,</a>
<a class="sourceLine" id="cb42-25" data-line-number="25">  <span class="dt">control =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb42-26" data-line-number="26">    <span class="dt">trace =</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb42-27" data-line-number="27">  ),</a>
<a class="sourceLine" id="cb42-28" data-line-number="28">  <span class="dt">initialSANN =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb42-29" data-line-number="29">    <span class="dt">maxit =</span> <span class="dv">1500</span>,</a>
<a class="sourceLine" id="cb42-30" data-line-number="30">    <span class="dt">trace =</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb42-31" data-line-number="31">  )</a>
<a class="sourceLine" id="cb42-32" data-line-number="32">)</a>
<a class="sourceLine" id="cb42-33" data-line-number="33">fit</a>
<a class="sourceLine" id="cb42-34" data-line-number="34">}</a></code></pre></div>
<p>The <em>tidy</em> and <em>purrrific</em> approach to model fitting is to store the model
results and estimated parameters as a list-column within our <em>nested</em> tibble.
This has the significant benefit of keeping all our data, model specifications,
model fits, parameter estimates — and, next, our model predictions — nicely
organized.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw">library</span>(pander)</a>
<a class="sourceLine" id="cb43-2" data-line-number="2">tbl_locs_fit &lt;-<span class="st"> </span>sf_locs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">fit =</span> furrr<span class="op">::</span><span class="kw">future_pmap</span>(<span class="kw">list</span>(<span class="dt">d =</span> data,<span class="dt">fixpar =</span> fixpar),</a>
<a class="sourceLine" id="cb43-4" data-line-number="4">                           fit_crawl),</a>
<a class="sourceLine" id="cb43-5" data-line-number="5">                <span class="dt">params =</span> <span class="kw">map</span>(fit, crawl<span class="op">::</span>tidy_crwFit))</a></code></pre></div>
<p>After successfully fitting our models, we can explore the parameter estimates
that are a result of that fit. The first set of tables are for our two seal
deployments and the model has been fit without any <em>activity</em> data.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw">panderOptions</span>(<span class="st">&#39;knitr.auto.asis&#39;</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb44-2" data-line-number="2">tbl_locs_fit<span class="op">$</span>params <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="st">  </span><span class="kw">walk</span>(pander<span class="op">::</span>pander,<span class="dt">caption =</span> <span class="st">&quot;crwMLE fit parameters&quot;</span>)</a></code></pre></div>
<table style="width:96%;">
<caption>crwMLE fit parameters</caption>
<colgroup>
<col width="31%" />
<col width="15%" />
<col width="16%" />
<col width="15%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">term</th>
<th align="center">estimate</th>
<th align="center">std.error</th>
<th align="center">conf.low</th>
<th align="center">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ln tau.x ln.sd.x</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">ln tau.y ln.sd.y</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">ln sigma (Intercept)</td>
<td align="center">7.279</td>
<td align="center">0.014</td>
<td align="center">7.252</td>
<td align="center">7.306</td>
</tr>
<tr class="even">
<td align="center">ln beta (Intercept)</td>
<td align="center">4.277</td>
<td align="center">0.591</td>
<td align="center">3.118</td>
<td align="center">5.436</td>
</tr>
<tr class="odd">
<td align="center">logLik</td>
<td align="center">-46741</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">AIC</td>
<td align="center">93487</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
</tbody>
</table>
<table style="width:96%;">
<caption>crwMLE fit parameters</caption>
<colgroup>
<col width="31%" />
<col width="15%" />
<col width="16%" />
<col width="15%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">term</th>
<th align="center">estimate</th>
<th align="center">std.error</th>
<th align="center">conf.low</th>
<th align="center">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ln tau.x ln.sd.x</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">ln tau.y ln.sd.y</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">ln sigma (Intercept)</td>
<td align="center">7.611</td>
<td align="center">0.045</td>
<td align="center">7.522</td>
<td align="center">7.7</td>
</tr>
<tr class="even">
<td align="center">ln beta (Intercept)</td>
<td align="center">-0.74</td>
<td align="center">0.115</td>
<td align="center">-0.967</td>
<td align="center">-0.514</td>
</tr>
<tr class="odd">
<td align="center">logLik</td>
<td align="center">-15491</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">AIC</td>
<td align="center">30986</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
</tbody>
</table>
<p>Our second set of tables are for our two seal deployments and the model has
been fit with inclusion of <em>activity</em> data.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">tbl_locs_activity_fit &lt;-<span class="st"> </span>tbl_locs_activity <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">fit =</span> furrr<span class="op">::</span><span class="kw">future_pmap</span>(<span class="kw">list</span>(<span class="dt">d =</span> data,<span class="dt">fixpar =</span> fixpar),</a>
<a class="sourceLine" id="cb45-3" data-line-number="3">                           fit_crawl),</a>
<a class="sourceLine" id="cb45-4" data-line-number="4">                <span class="dt">params =</span> <span class="kw">map</span>(fit, crawl<span class="op">::</span>tidy_crwFit))</a></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="kw">panderOptions</span>(<span class="st">&#39;knitr.auto.asis&#39;</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb46-2" data-line-number="2">tbl_locs_activity_fit<span class="op">$</span>params <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="st">  </span><span class="kw">walk</span>(pander<span class="op">::</span>pander,<span class="dt">caption =</span> <span class="st">&quot;crwMLE fit parameters&quot;</span>)</a></code></pre></div>
<table style="width:96%;">
<caption>crwMLE fit parameters</caption>
<colgroup>
<col width="31%" />
<col width="15%" />
<col width="16%" />
<col width="15%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">term</th>
<th align="center">estimate</th>
<th align="center">std.error</th>
<th align="center">conf.low</th>
<th align="center">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ln tau.x ln.sd.x</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">ln tau.y ln.sd.y</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">ln sigma (Intercept)</td>
<td align="center">7.281</td>
<td align="center">0.014</td>
<td align="center">7.254</td>
<td align="center">7.308</td>
</tr>
<tr class="even">
<td align="center">ln beta (Intercept)</td>
<td align="center">4.315</td>
<td align="center">0.631</td>
<td align="center">3.079</td>
<td align="center">5.551</td>
</tr>
<tr class="odd">
<td align="center">ln phi</td>
<td align="center">0</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">logLik</td>
<td align="center">-46622</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">AIC</td>
<td align="center">93248</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
</tbody>
</table>
<table style="width:96%;">
<caption>crwMLE fit parameters</caption>
<colgroup>
<col width="31%" />
<col width="15%" />
<col width="16%" />
<col width="15%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">term</th>
<th align="center">estimate</th>
<th align="center">std.error</th>
<th align="center">conf.low</th>
<th align="center">conf.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">ln tau.x ln.sd.x</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">ln tau.y ln.sd.y</td>
<td align="center">1</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">ln sigma (Intercept)</td>
<td align="center">7.623</td>
<td align="center">0.046</td>
<td align="center">7.533</td>
<td align="center">7.712</td>
</tr>
<tr class="even">
<td align="center">ln beta (Intercept)</td>
<td align="center">-0.767</td>
<td align="center">0.115</td>
<td align="center">-0.991</td>
<td align="center">-0.542</td>
</tr>
<tr class="odd">
<td align="center">ln phi</td>
<td align="center">0</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">logLik</td>
<td align="center">-15403</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">AIC</td>
<td align="center">30809</td>
<td align="center">NA</td>
<td align="center">NA</td>
<td align="center">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="exploring-and-troubleshooting-model-results" class="section level2">
<h2><span class="header-section-number">2.7</span> Exploring and Troubleshooting Model Results</h2>
</div>
<div id="predicting-a-movement-track" class="section level2">
<h2><span class="header-section-number">2.8</span> Predicting a Movement Track</h2>
<p>At this point, we have a fitted model for each seal and the next obvious step
is to visualize and explore the resulting fitted track. To accomplish this,
we’ll rely on the <code>crawl::crwPredict()</code> function. This function requires two
key arguments: an <code>object.crwFit</code> and a <code>predTime</code> argument. The first is
simply the fit object from our model fit. The second can be one of two types:</p>
<ol style="list-style-type: decimal">
<li>a vector of POSIXct or numeric values that provide additional prediction
times beyond the times for our observed locations in the original data. This
vector should not start before the first observation or end after the last
observation.</li>
<li>if the original data were provided as a POSIXct type (which, in this example,
they were), then <code>crawl::crwPredict()</code> can derive a sequence of regularly
spaced prediction times from the original data. The user only needs to provide
a character string that describes the regularly spaced duration. This character
string should correspond to the <code>by</code> argument of the <code>seq.POSIXt</code> function
(e.g. ‘1 hour’, ‘30 mins’).</li>
</ol>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1">tbl_locs_fit &lt;-<span class="st"> </span>tbl_locs_fit <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">predict =</span> furrr<span class="op">::</span><span class="kw">future_map</span>(fit,</a>
<a class="sourceLine" id="cb47-3" data-line-number="3">                                     crawl<span class="op">::</span>crwPredict,</a>
<a class="sourceLine" id="cb47-4" data-line-number="4">                                     <span class="dt">predTime =</span> <span class="st">&#39;1 hour&#39;</span>)) </a></code></pre></div>
<p>We still need to perform some additional processing of the prediction object
before we can use the information in analysis or visualize the track. We will
create a custom function <code>as.sf()</code> which will convert our <code>crwPredict</code> object
into an <code>sf</code> object of either “POINT” or “MULTILINESTRING”</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1">tbl_locs_fit &lt;-<span class="st"> </span>tbl_locs_fit <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">sf_points =</span> purrr<span class="op">::</span><span class="kw">map</span>(predict,</a>
<a class="sourceLine" id="cb48-3" data-line-number="3">                                       crawl<span class="op">::</span>crw_as_sf,</a>
<a class="sourceLine" id="cb48-4" data-line-number="4">                                       <span class="dt">ftype =</span> <span class="st">&quot;POINT&quot;</span>,</a>
<a class="sourceLine" id="cb48-5" data-line-number="5">                                       <span class="dt">locType =</span> <span class="st">&quot;p&quot;</span>),</a>
<a class="sourceLine" id="cb48-6" data-line-number="6">                <span class="dt">sf_line =</span> purrr<span class="op">::</span><span class="kw">map</span>(predict,</a>
<a class="sourceLine" id="cb48-7" data-line-number="7">                                     crawl<span class="op">::</span>crw_as_sf,</a>
<a class="sourceLine" id="cb48-8" data-line-number="8">                                     <span class="dt">ftype =</span> <span class="st">&quot;LINESTRING&quot;</span>,</a>
<a class="sourceLine" id="cb48-9" data-line-number="9">                                     <span class="dt">locType =</span> <span class="st">&quot;p&quot;</span>)</a>
<a class="sourceLine" id="cb48-10" data-line-number="10">                )</a></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1">sf_pred_lines &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind,tbl_locs_fit<span class="op">$</span>sf_line) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">id =</span> tbl_locs_fit<span class="op">$</span>deployid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-3" data-line-number="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">deployid =</span> id)</a>
<a class="sourceLine" id="cb49-4" data-line-number="4"></a>
<a class="sourceLine" id="cb49-5" data-line-number="5">sf_pred_points &lt;-<span class="st"> </span>tbl_locs_fit <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw">unnest</span>(sf_points) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">geometry =</span> sf<span class="op">::</span><span class="kw">st_sfc</span>(geometry)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-7" data-line-number="7"><span class="st">  </span>sf<span class="op">::</span><span class="kw">st_as_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span>sf<span class="op">::</span><span class="kw">st_set_crs</span>(<span class="dv">3571</span>)</a></code></pre></div>

<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1">esri_ocean &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;https://services.arcgisonline.com/arcgis/rest/services/&#39;</span>,</a>
<a class="sourceLine" id="cb50-2" data-line-number="2">                     <span class="st">&#39;Ocean/World_Ocean_Base/MapServer/tile/${z}/${y}/${x}.jpeg&#39;</span>)</a>
<a class="sourceLine" id="cb50-3" data-line-number="3"></a>
<a class="sourceLine" id="cb50-4" data-line-number="4"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="st">  </span><span class="kw">annotation_map_tile</span>(<span class="dt">type =</span> esri_ocean,<span class="dt">zoomin =</span> <span class="dv">1</span>,<span class="dt">progress =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb50-6" data-line-number="6"><span class="st">  </span><span class="kw">layer_spatial</span>(sf_pred_lines, <span class="dt">size =</span> <span class="fl">0.75</span>,<span class="kw">aes</span>(<span class="dt">color =</span> deployid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb50-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">expand =</span> <span class="kw">expand_scale</span>(<span class="dt">mult =</span> <span class="kw">c</span>(.<span class="dv">6</span>, <span class="fl">.6</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb50-8" data-line-number="8"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand =</span> <span class="kw">expand_scale</span>(<span class="dt">mult =</span> <span class="kw">c</span>(<span class="fl">0.35</span>, <span class="fl">0.35</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb50-9" data-line-number="9"><span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Dark2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb50-10" data-line-number="10"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb50-11" data-line-number="11"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Predicted Location Paths&quot;</span>, </a>
<a class="sourceLine" id="cb50-12" data-line-number="12">          <span class="dt">subtitle =</span> <span class="st">&quot;harbor seals (n=2), Aleutian Islands, Alaska, USA&quot;</span>)</a></code></pre></div>
<div class="figure"><span id="fig:map-pred-lines"></span>
<img src="images/map-pred-lines-1.png" alt="An interactive map of predicted tracks from two harbor seals in the Aleutian Islands." width="672" />
<p class="caption">
Figure 2.7: An interactive map of predicted tracks from two harbor seals in the Aleutian Islands.
</p>
</div>
</div>
<div id="simulating-tracks-from-the-posterior" class="section level2">
<h2><span class="header-section-number">2.9</span> Simulating Tracks from the Posterior</h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1">.get_sim_tracks &lt;-<span class="st"> </span><span class="cf">function</span>(crw_fit,iter) {</a>
<a class="sourceLine" id="cb51-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb51-3" data-line-number="3">  simObj &lt;-<span class="st"> </span>crw_fit <span class="op">%&gt;%</span><span class="st"> </span>crawl<span class="op">::</span><span class="kw">crwSimulator</span>(<span class="dt">predTime =</span> <span class="st">&#39;1 hour&#39;</span>)</a>
<a class="sourceLine" id="cb51-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb51-5" data-line-number="5">  sim_tracks =<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb51-6" data-line-number="6">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>iter) {</a>
<a class="sourceLine" id="cb51-7" data-line-number="7">    sim_tracks[[i]] &lt;-<span class="st"> </span>crawl<span class="op">::</span><span class="kw">crwPostIS</span>(simObj, <span class="dt">fullPost =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb51-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb51-9" data-line-number="9">  <span class="kw">return</span>(sim_tracks)</a>
<a class="sourceLine" id="cb51-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb51-11" data-line-number="11"></a>
<a class="sourceLine" id="cb51-12" data-line-number="12">tbl_locs_fit &lt;-<span class="st"> </span>tbl_locs_fit <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb51-13" data-line-number="13"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">sim_tracks =</span> purrr<span class="op">::</span><span class="kw">map</span>(fit,</a>
<a class="sourceLine" id="cb51-14" data-line-number="14">                                       .get_sim_tracks,</a>
<a class="sourceLine" id="cb51-15" data-line-number="15">                                       <span class="dt">iter =</span> <span class="dv">5</span>))</a>
<a class="sourceLine" id="cb51-16" data-line-number="16"></a>
<a class="sourceLine" id="cb51-17" data-line-number="17">tbl_locs_fit &lt;-<span class="st"> </span>tbl_locs_fit <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb51-18" data-line-number="18"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">sim_lines =</span> crawl<span class="op">::</span><span class="kw">crw_as_sf</span>(.<span class="op">$</span>sim_tracks, <span class="dt">ftype =</span> <span class="st">&quot;MULTILINESTRING&quot;</span>,</a>
<a class="sourceLine" id="cb51-19" data-line-number="19">                                             <span class="dt">locType =</span> <span class="st">&quot;p&quot;</span>))</a></code></pre></div>
</div>
<div id="visualization-of-results" class="section level2">
<h2><span class="header-section-number">2.10</span> Visualization of Results</h2>

<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1">sf_sim_lines &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind,tbl_locs_fit<span class="op">$</span>sim_lines) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">id =</span> tbl_locs_fit<span class="op">$</span>deployid) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-3" data-line-number="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">deployid =</span> id)</a>
<a class="sourceLine" id="cb52-4" data-line-number="4"></a>
<a class="sourceLine" id="cb52-5" data-line-number="5">esri_ocean &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;https://services.arcgisonline.com/arcgis/rest/services/&#39;</span>,</a>
<a class="sourceLine" id="cb52-6" data-line-number="6">                     <span class="st">&#39;Ocean/World_Ocean_Base/MapServer/tile/${z}/${y}/${x}.jpeg&#39;</span>)</a>
<a class="sourceLine" id="cb52-7" data-line-number="7"></a>
<a class="sourceLine" id="cb52-8" data-line-number="8"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-9" data-line-number="9"><span class="st">  </span><span class="kw">annotation_map_tile</span>(<span class="dt">type =</span> esri_ocean,<span class="dt">zoomin =</span> <span class="dv">1</span>,<span class="dt">progress =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-10" data-line-number="10"><span class="st">  </span><span class="kw">layer_spatial</span>(sf_sim_lines, <span class="dt">size =</span> <span class="fl">0.25</span>, <span class="dt">alpha =</span> <span class="fl">0.1</span>, <span class="kw">aes</span>(<span class="dt">color =</span> deployid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="st">  </span><span class="kw">facet_grid</span>(<span class="dt">rows =</span> <span class="kw">vars</span>(deployid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">expand =</span> <span class="kw">expand_scale</span>(<span class="dt">mult =</span> <span class="kw">c</span>(.<span class="dv">6</span>, <span class="fl">.6</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-13" data-line-number="13"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand =</span> <span class="kw">expand_scale</span>(<span class="dt">mult =</span> <span class="kw">c</span>(<span class="fl">0.35</span>, <span class="fl">0.35</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-14" data-line-number="14"><span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Dark2&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-15" data-line-number="15"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-16" data-line-number="16"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Simulated Location Paths&quot;</span>, </a>
<a class="sourceLine" id="cb52-17" data-line-number="17">          <span class="dt">subtitle =</span> <span class="st">&quot;harbor seals (n=2), Aleutian Islands, Alaska, USA&quot;</span>)</a></code></pre></div>
<div class="figure"><span id="fig:map-sim-lines"></span>
<img src="images/map-sim-lines-1.png" alt="An interactive map of simulated tracks from two harbor seals in the Aleutian Islands." width="576" />
<p class="caption">
Figure 2.8: An interactive map of simulated tracks from two harbor seals in the Aleutian Islands.
</p>
</div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="crawl-theory.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/lunr.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "none"
}
});
});
</script>

</body>

</html>
